name: Continuous integration with lint check and pytest

on:
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Run Ruff linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Ruff lint
        uses: chartboost/ruff-action@v1
        with:
          version: "0.9.9"
          args: check .

      - name: Run Ruff format
        uses: chartboost/ruff-action@v1
        with:
          version: "0.9.9"
          args: format --check .

  poetry-lock-check:
    name: Check if poetry.lock is up to date
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Set up poetry
        uses: abatilo/actions-poetry@v2
        with:
          poetry-version: "2.1.1"

      - name: Check if poetry.lock is in sync with pyproject.toml
        run: poetry check --lock

  test:
    name: Run tests
    runs-on: ubuntu-latest

    env:
      DATA_FOLDER_ID: ${{ secrets.DATA_FOLDER_ID }}
      KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
      PIP_CACHE_DIR: /tmp/pip
      POETRY_CACHE_DIR: /tmp/poetry
      HF_HOME: /tmp/hf
      TORCH_HOME: /tmp/torch

    steps:
      - name: Safe Disk Cleanup
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /home/runner/.cache
          df -h

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Set up poetry
        uses: abatilo/actions-poetry@v2
        with:
          poetry-version: "2.1.1"

      - name: Install dependencies (NO CACHE)
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-root --no-interaction

      - name: Run pytest (Safe Mode)
        run: |
          poetry run pytest -q --disable-warnings --maxfail=1 --cache-clear
